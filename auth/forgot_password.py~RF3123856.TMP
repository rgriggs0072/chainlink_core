# ---------- forgot_password.py ----------

import streamlit as st
import secrets
import smtplib
from utils.email_utils import send_reset_email
from datetime import datetime, timedelta, timezone
from sf_connector.service_connector import get_service_account_connection

def forgot_password():
    st.title("?? Forgot Password")

    with st.form("forgot_password_form"):
        email = st.text_input("Enter your email address")
        submit = st.form_submit_button("Send Reset Link")

        if submit:
            if not email:
                st.warning("Please enter your email address.")
                return

            conn = get_service_account_connection()
            cur = conn.cursor()

            try:
                cur.execute("""
                    SELECT TENANT_ID FROM USERDATA WHERE EMAIL = %s
                """, (email,))
                row = cur.fetchone()

                if not row:
                    st.info("If that email is registered, a reset link will be sent.")
                    return  # Exit silently — don’t reveal valid/invalid email status

                tenant_id = row[0]
                cur.execute("""
                SELECT FIRST_NAME FROM USERDATA WHERE EMAIL = %s
                """, (email,))
                name_row = cur.fetchone()
                row_first_name = name_row[0] if name_row else "User"
                token = secrets.token_urlsafe()
                expiry = datetime.now(timezone.utc) + timedelta(hours=1)

                cur.execute("""
                    UPDATE USERDATA
                    SET RESET_TOKEN = %s, TOKEN_EXPIRY = %s
                    WHERE EMAIL = %s
                """, (token, expiry, email))
                conn.commit()

                send_reset_email(email, token, first_name=row_first_name)
                st.success("? If the email exists, a reset link has been sent.")
            except Exception as e:
                st.error("? Failed to process password reset.")
                st.exception(e)
            finally:
                cur.close()
                conn.close()

